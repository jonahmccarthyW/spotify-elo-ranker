<!DOCTYPE html>
<html>
<head>
    <title>Vote!</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; }
        .arena { display: flex; justify-content: center; align-items: center; height: 80vh; gap: 40px; }

        /* --- CARD STYLES --- */
        .card {
            background: #282828; padding: 20px; border-radius: 10px; width: 300px;
            display: flex; flex-direction: column; position: relative; transition: 0.3s;
        }
        .card.winner {
            background: #1a4d2e;
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.5);
        }
        .card.loser {
            background: #1a1a1a;
            opacity: 0.6;
        }

        img { width: 100%; border-radius: 5px; margin-bottom: 15px; }

        /* Song Title */
        h2 {
            margin: 10px 0 5px 0;
            font-size: 1.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white; /* Always white */
        }

        p { color: #b3b3b3; margin-bottom: 20px; font-size: 0.9rem; }

        /* --- CHECKMARK --- */
        .checkmark {
            position: absolute;
            top: -50px; right: -20px;
            font-size: 10rem; color: #1DB954;
            opacity: 0; transform: scale(0);
            transition: all 0.4s ease;
            z-index: 10;
        }
        .checkmark.show { opacity: 1; transform: scale(1); }

        /* --- BUTTONS --- */
        .btn-vote {
            background: #0ca55d; border: none; padding: 15px 30px;
            color: #000000; font-size: 1rem; cursor: pointer;
            border-radius: 30px; width: 100%; transition: 0.2s; font-weight: bold;
            margin-top: auto;
        }
        .btn-vote:hover { transform: scale(1.05); background: #1ed760; }
        .btn-vote:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; }

        .btn-play {
            background: transparent; border: 2px solid #555;
            color: #ccc; padding: 8px 15px; margin-bottom: 15px;
            cursor: pointer; border-radius: 20px; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-play:hover { border-color: white; color: white; background: rgba(255,255,255,0.1); }

        /* Active Play Button Style */
        .btn-playing {
            border-color: #1DB954 !important;
            color: #1DB954 !important;
            background: rgba(29, 185, 84, 0.1) !important;
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.2);
        }

        /* --- CENTER CONTROLS --- */
        .center-col { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .vs { font-size: 2rem; font-weight: bold; color: #555; }

        .btn-next {
            background: #1DB954; color: #000; border: none;
            padding: 12px 25px; border-radius: 25px; cursor: pointer;
            font-size: 0.95rem; transition: 0.2s; font-weight: bold;
        }
        .btn-next:hover { background: #1ed760; transform: scale(1.05); }

        .controls { margin-top: -20px; margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; }
        .btn-control {
            background: #333; color: white; border: none;
            padding: 10px 20px; border-radius: 50px; cursor: pointer;
            font-size: 0.9rem; display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-control:hover { background: #444; }
    </style>
</head>
<body>

    <div class="arena">
        <div class="card" id="cardA">
            <div class="checkmark" id="checkA">‚úì</div>
            <img src="{{ song_a.image }}">

            <h2 id="titleA">{{ song_a.name }}</h2>
            <p>{{ song_a.artist }}</p>

            <button type="button" class="btn-play" id="btnPlayA"
                onclick="playSingleSong('{{ song_a.uri }}')">
                ‚ñ∂ Play
            </button>

            <button type="button" class="btn-vote" id="voteA" onclick="castVote('{{ song_a.uri }}', '{{ song_b.uri }}')">
                Vote Left
            </button>
        </div>

        <div class="center-col">
            <div class="vs">VS</div>
            <form action="/rank" method="POST" id="nextMatchForm">
                <input type="hidden" name="next_match" value="true">
                <button type="submit" class="btn-next" id="nextBtn">Next Match</button>
            </form>
        </div>

        <div class="card" id="cardB">
            <div class="checkmark" id="checkB">‚úì</div>
            <img src="{{ song_b.image }}">

            <h2 id="titleB">{{ song_b.name }}</h2>
            <p>{{ song_b.artist }}</p>

            <button type="button" class="btn-play" id="btnPlayB"
                onclick="playSingleSong('{{ song_b.uri }}')">
                ‚ñ∂ Play
            </button>

            <button type="button" class="btn-vote" id="voteB" onclick="castVote('{{ song_b.uri }}', '{{ song_a.uri }}')">
                Vote Right
            </button>
        </div>
    </div>

    <div class="controls">
        <button class="btn-control" id="playPauseBtn" onclick="togglePlayback()">
            ‚è∏Ô∏è Pause
        </button>
        <button class="btn-control" onclick="skipForward()">
            ‚è© Skip 10s
        </button>
    </div>

    <div style="text-align: center; margin-top: 10px;">
        <a href="/dashboard" style="color: #444; text-decoration: none; font-size: 0.8rem;">Back to Dashboard</a>
    </div>

    <script>
        // --- CONFIG ---
        const songAUri = "{{ song_a.uri }}";
        const songBUri = "{{ song_b.uri }}";

        // --- STATE ---
        let hasVoted = false;
        let playbackMode = 'pair'; // 'pair' or 'single'
        let isPlaying = true;
        let pollInterval = null;

        // --- DOM ELEMENTS ---
        const playPauseBtn = document.getElementById('playPauseBtn');
        const btnPlayA = document.getElementById('btnPlayA');
        const btnPlayB = document.getElementById('btnPlayB');

        // --- INIT ---
        window.addEventListener('load', function() {
            // Start pair playback
            fetch(`/play_match?uri_a=${songAUri}&uri_b=${songBUri}`)
            .then(r => {
                if (r.ok) {
                    playbackMode = 'pair';
                    startPolling();
                } else {
                    console.error("Spotify Connect Error");
                }
            });
        });

        // --- ACTIONS ---

        function playSingleSong(uri) {
            fetch('/play/' + uri).then(r => {
                if (r.ok) {
                    playbackMode = 'single';
                    isPlaying = true;
                    playPauseBtn.innerHTML = '‚è∏Ô∏è Pause';
                    // Force an immediate check
                    setTimeout(checkPlaybackStatus, 500);
                }
            });
        }

        function togglePlayback() {
            fetch('/toggle_playback', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.is_playing !== undefined) {
                    isPlaying = data.is_playing;
                    // Force UI update immediately
                    checkPlaybackStatus();
                }
            });
        }

        function skipForward() {
            fetch('/skip_forward');
        }

        function castVote(winner, loser) {
            if (hasVoted) return;

            const formData = new FormData();
            formData.append('winner', winner);
            formData.append('loser', loser);

            fetch('/rank', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    hasVoted = true;
                    showVoteConfirmation(winner);

                    // Disable buttons
                    document.getElementById('voteA').disabled = true;
                    document.getElementById('voteB').disabled = true;
                    document.getElementById('btnPlayA').disabled = true;
                    document.getElementById('btnPlayB').disabled = true;
                }
            });
        }

        function showVoteConfirmation(winnerUri) {
            const cardA = document.getElementById('cardA');
            const cardB = document.getElementById('cardB');
            const checkA = document.getElementById('checkA');
            const checkB = document.getElementById('checkB');

            if (winnerUri === songAUri) {
                cardA.classList.add('winner');
                cardB.classList.add('loser');
                checkA.classList.add('show');
            } else {
                cardB.classList.add('winner');
                cardA.classList.add('loser');
                checkB.classList.add('show');
            }
        }

        // --- POLLING LOOP ---

        function startPolling() {
            pollInterval = setInterval(checkPlaybackStatus, 1000); // Check every second
        }

        function checkPlaybackStatus() {
            fetch('/api/playback_status')
            .then(r => r.json())
            .then(data => {
                if (data.error) return;

                // 1. UPDATE PLAY BUTTON (Global)
                if (data.is_playing !== isPlaying) {
                    isPlaying = data.is_playing;
                    playPauseBtn.innerHTML = isPlaying ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
                }

                // 2. UPDATE BUTTON STATES
                // Reset defaults
                btnPlayA.classList.remove('btn-playing');
                btnPlayA.innerText = "‚ñ∂ Play";

                btnPlayB.classList.remove('btn-playing');
                btnPlayB.innerText = "‚ñ∂ Play";

                // Highlight active button only
                if (data.is_playing && data.current_uri) {
                    if (data.current_uri === songAUri) {
                        btnPlayA.classList.add('btn-playing');
                        btnPlayA.innerText = "üîä Playing";
                    } else if (data.current_uri === songBUri) {
                        btnPlayB.classList.add('btn-playing');
                        btnPlayB.innerText = "üîä Playing";
                    }
                }

                // 3. AUTO ADVANCE LOGIC
                const timeRemaining = data.duration_ms - data.progress_ms;

                // If song is almost over (< 2s)
                if (data.is_playing && timeRemaining < 2000 && timeRemaining > 0) {
                    if (playbackMode === 'pair' && data.current_uri === songBUri) {
                        advanceToNextMatch();
                    }
                    else if (playbackMode === 'single') {
                        advanceToNextMatch();
                    }
                }
            })
            .catch(console.error);
        }

        function advanceToNextMatch() {
            clearInterval(pollInterval);
            // Submit form to reload page
            document.getElementById('nextMatchForm').submit();
        }

        // Handle manual next match click
        document.getElementById('nextBtn').addEventListener('click', function(e) {
            clearInterval(pollInterval);
        });
    </script>
</body>
</html>