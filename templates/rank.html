<!DOCTYPE html>
<html>
<head>
    <title>Vote!</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; }
        .arena { display: flex; justify-content: center; align-items: center; height: 80vh; gap: 40px; }

        /* Card Styles */
        .card {
            background: #282828; padding: 20px; border-radius: 10px; width: 300px;
            display: flex; flex-direction: column; position: relative; transition: 0.3s;
        }
        .card.winner {
            background: #1a4d2e;
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.5);
        }
        .card.loser {
            background: #1a1a1a;
            opacity: 0.6;
        }
        img { width: 100%; border-radius: 5px; margin-bottom: 15px; }
        h2 { margin: 10px 0 5px 0; font-size: 1.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        p { color: #b3b3b3; margin-bottom: 20px; font-size: 0.9rem; }

        /* Checkmark for winner */
        .checkmark {
            position: absolute;
            top: -50px;
            right: -20px;
            font-size: 10rem;
            color: #1DB954;
            opacity: 0;
            transform: scale(0);
            transition: all 0.4s ease;
        }
        .checkmark.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Buttons */
        .btn-vote {
            background: #0ca55d; border: none; padding: 15px 30px;
            color: #000000; font-size: 1rem; cursor: pointer;
            border-radius: 30px; width: 100%; transition: 0.2s; font-weight: bold;
            margin-top: auto;
        }
        .btn-vote:hover { transform: scale(1.05); background: #1ed760; }
        .btn-vote:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .btn-play {
            background: transparent; border: 2px solid #555;
            color: #ccc; padding: 8px 15px; margin-bottom: 15px;
            cursor: pointer; border-radius: 20px; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-play:hover { border-color: white; color: white; background: rgba(255,255,255,0.1); }

        /* Center Column (VS + Controls) */
        .center-col { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .vs { font-size: 2rem; font-weight: bold; color: #555; }

        .btn-next {
            background: #1DB954; color: #000; border: none;
            padding: 12px 25px; border-radius: 25px; cursor: pointer;
            font-size: 0.95rem; transition: 0.2s; font-weight: bold;
        }
        .btn-next:hover { background: #1ed760; transform: scale(1.05); }

        /* Bottom Controls */
        .controls { margin-top: -20px; margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; }
        .btn-control {
            background: #333; color: white; border: none;
            padding: 10px 20px; border-radius: 50px; cursor: pointer;
            font-size: 0.9rem; display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-control:hover { background: #444; }

        #status { margin-top: 10px; color: #1DB954; font-size: 0.85rem; height: 20px; font-weight: bold; }

        .vote-message {
            background: #1DB954;
            color: #000;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.4s ease;
        }
        .vote-message.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div id="voteMessage" class="vote-message">✓ Vote recorded!</div>

    <div class="arena">
        <div class="card" id="cardA">
            <div class="checkmark" id="checkA">✓</div>
            <img src="{{ song_a.image }}">
            <h2>{{ song_a.name }}</h2>
            <p>{{ song_a.artist }}</p>
            <button type="button" class="btn-play"
                onclick="playSingleSong('{{ song_a.uri }}', '{{ song_a.name | replace("'", "\\'") }}')">
                ▶ Play
            </button>
            <button type="button" class="btn-vote" id="voteA" onclick="castVote('{{ song_a.uri }}', '{{ song_b.uri }}')">
                Vote Left
            </button>
        </div>

        <div class="center-col">
            <div class="vs">VS</div>
            <form action="/rank" method="POST" id="nextMatchForm">
                <input type="hidden" name="next_match" value="true">
                <button type="submit" class="btn-next" id="nextBtn">Next Match</button>
            </form>
        </div>

        <div class="card" id="cardB">
            <div class="checkmark" id="checkB">✓</div>
            <img src="{{ song_b.image }}">
            <h2>{{ song_b.name }}</h2>
            <p>{{ song_b.artist }}</p>
            <button type="button" class="btn-play"
                onclick="playSingleSong('{{ song_b.uri }}', '{{ song_b.name | replace("'", "\\'") }}')">
                ▶ Play
            </button>
            <button type="button" class="btn-vote" id="voteB" onclick="castVote('{{ song_b.uri }}', '{{ song_a.uri }}')">
                Vote Right
            </button>
        </div>
    </div>

    <div class="controls">
        <button class="btn-control" id="playPauseBtn" onclick="togglePlayback()">
            ⏸️ Pause
        </button>
        <button class="btn-control" onclick="skipForward()">
            ⏩ Skip 10s
        </button>
    </div>

    <div id="status">Connecting to Spotify...</div>
    <a href="/dashboard" style="color: #bdbdbd; text-decoration: none;">Back to Dashboard</a>

    <script>
        // State management
        let hasVoted = false;
        let playbackMode = 'pair'; // 'pair' or 'single'
        let votedWinner = null;
        let isPlaying = true;
        let pollInterval = null;

        const songAUri = "{{ song_a.uri }}";
        const songBUri = "{{ song_b.uri }}";
        const songAName = {{ song_a.name | tojson }};
        const songBName = {{ song_b.name | tojson }};

        const statusDiv = document.getElementById('status');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const voteMessage = document.getElementById('voteMessage');

        // Auto-play both songs on load
        window.addEventListener('load', function() {
            fetch(`/play_match?uri_a=${songAUri}&uri_b=${songBUri}`)
            .then(r => {
                if (r.ok) {
                    statusDiv.innerText = "▶ Playing: " + songAName;
                    playbackMode = 'pair';
                    startPolling();
                } else {
                    statusDiv.innerText = "⚠️ Connection Error - No active device";
                }
            });
        });

        // Play single song
        function playSingleSong(uri, songName) {
            fetch('/play/' + uri).then(r => {
                if (r.ok) {
                    statusDiv.innerText = "▶ Playing: " + songName;
                    playbackMode = 'single';
                    isPlaying = true;
                    playPauseBtn.innerHTML = '⏸️ Pause';
                }
            });
        }

        // Toggle play/pause
        function togglePlayback() {
            fetch('/toggle_playback', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.is_playing !== undefined) {
                    isPlaying = data.is_playing;
                    playPauseBtn.innerHTML = isPlaying ? '⏸️ Pause' : '▶️ Play';
                    statusDiv.innerText = isPlaying ? '▶ Playing' : '⏸ Paused';
                }
            });
        }

        // Skip forward 10 seconds
        function skipForward() {
            fetch('/skip_forward')
            .then(response => {
                if (response.ok) {
                    const prevText = statusDiv.innerText;
                    statusDiv.innerText = "⏩ Skipped forward 10s";
                    setTimeout(() => statusDiv.innerText = prevText, 800);
                }
            });
        }

        // Cast vote via AJAX
        function castVote(winner, loser) {
            if (hasVoted) return; // Prevent double voting

            const formData = new FormData();
            formData.append('winner', winner);
            formData.append('loser', loser);

            fetch('/rank', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    hasVoted = true;
                    votedWinner = data.winner_uri;

                    // Visual feedback
                    showVoteConfirmation(winner);

                    // Disable vote buttons
                    document.getElementById('voteA').disabled = true;
                    document.getElementById('voteB').disabled = true;
                }
            });
        }

        // Visual feedback for vote
        function showVoteConfirmation(winnerUri) {
            const cardA = document.getElementById('cardA');
            const cardB = document.getElementById('cardB');
            const checkA = document.getElementById('checkA');
            const checkB = document.getElementById('checkB');

            if (winnerUri === songAUri) {
                cardA.classList.add('winner');
                cardB.classList.add('loser');
                checkA.classList.add('show');
            } else {
                cardB.classList.add('winner');
                cardA.classList.add('loser');
                checkB.classList.add('show');
            }

            // Show success message
            voteMessage.classList.add('show');
            setTimeout(() => voteMessage.classList.remove('show'), 3000);
        }

        // Poll playback status
        function startPolling() {
            // Poll every 2 seconds
            pollInterval = setInterval(checkPlaybackStatus, 2000);
        }

        function checkPlaybackStatus() {
            fetch('/api/playback_status')
            .then(r => r.json())
            .then(data => {
                if (data.error) return;

                const currentUri = data.current_uri;
                const timeRemaining = data.duration_ms - data.progress_ms;

                // Update play/pause button state
                if (data.is_playing !== isPlaying) {
                    isPlaying = data.is_playing;
                    playPauseBtn.innerHTML = isPlaying ? '⏸️ Pause' : '▶️ Play';
                }

                // Check if song is about to end (< 3 seconds remaining)
                if (data.is_playing && timeRemaining < 3000) {
                    // In pair mode: trigger next match when Song B ends
                    if (playbackMode === 'pair' && currentUri === songBUri) {
                        advanceToNextMatch();
                    }
                    // In single mode: always trigger next match when song ends
                    else if (playbackMode === 'single') {
                        advanceToNextMatch();
                    }
                }
            })
            .catch(err => console.error('Polling error:', err));
        }

        function advanceToNextMatch() {
            clearInterval(pollInterval); // Stop polling
            statusDiv.innerText = "Loading next match...";
            document.getElementById('nextMatchForm').submit();
        }

        // Manual next match (doesn't affect ratings)
        document.getElementById('nextBtn').addEventListener('click', function(e) {
            clearInterval(pollInterval);
        });
    </script>
</body>
</html>